{% extends "layout.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-content">
                <div class="logo">
                    <img src="{{ url_for('static', filename='images/surview_logo.svg') }}" alt="Surview.io">
                </div>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a href="{{ url_for('homepage') }}" class="nav-link {% if request.endpoint == 'homepage' %}active{% endif %}">
                            <i class="bi bi-grid"></i> <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="{{ url_for('create_surview') }}" class="nav-link {% if request.endpoint == 'create_surview' %}active{% endif %}">
                            <i class="bi bi-plus-square"></i> <span>Create Surview</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link">
                            <i class="bi bi-folder"></i> <span>Workspace</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link">
                            <i class="bi bi-gear"></i> <span>Settings</span>
                        </a>
                    </li>
                </ul>
            </div>
            <div class="user-info">
                <img src="{{ url_for('static', filename='images/default_avatar.jpg') }}" alt="User Avatar">
                <div class="user-details">
                    <span class="user-name">{{ session.get('user', 'Guest') }}</span>
                    <span class="user-status">Free Account</span>
                </div>
            </div>
        </nav>

        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <h1 class="mt-4 mb-4">Edit Survey Questions</h1>
            <form id="edit-questions-form" method="POST">
                <div id="questions-container">
                    {% for question in questions %}
                    <div class="question-item mb-3">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <button type="button" class="btn btn-outline-secondary btn-sm move-up" title="Move Up">↑</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm move-down" title="Move Down">↓</button>
                            </div>
                            <div class="flex-grow-1">
                                <label for="question{{ loop.index }}" class="form-label">Question {{ loop.index }}</label>
                                <input type="text" class="form-control" id="question{{ loop.index }}" name="questions[]" value="{{ question }}" required>
                            </div>
                            <div class="ms-3">
                                <button type="button" class="btn btn-outline-danger btn-sm remove-question" title="Remove Question">×</button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="mt-3 mb-4">
                    <button type="button" id="add-question" class="btn btn-outline-primary">Add Question</button>
                </div>
                <div class="mt-4">
                    <button type="submit" class="btn btn-primary">Save Questions</button>
                    <button type="button" id="regenerate-questions" class="btn btn-secondary ms-2">Regenerate Questions</button>
                    <a href="{{ url_for('homepage') }}" class="btn btn-outline-secondary ms-2">Cancel</a>
                </div>
            </form>
        </main>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('questions-container');

    function updateQuestionNumbers() {
        const labels = container.querySelectorAll('.form-label');
        labels.forEach((label, index) => {
            label.textContent = `Question ${index + 1}`;
        });
    }

    function createQuestionItem(questionText = '') {
        const questionCount = container.children.length + 1;
        const questionItem = document.createElement('div');
        questionItem.className = 'question-item mb-3';
        questionItem.innerHTML = `
            <div class="d-flex align-items-center">
                <div class="me-3">
                    <button type="button" class="btn btn-outline-secondary btn-sm move-up" title="Move Up">↑</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm move-down" title="Move Down">↓</button>
                </div>
                <div class="flex-grow-1">
                    <label for="question${questionCount}" class="form-label">Question ${questionCount}</label>
                    <input type="text" class="form-control" id="question${questionCount}" name="questions[]" value="${questionText}" required>
                </div>
                <div class="ms-3">
                    <button type="button" class="btn btn-outline-danger btn-sm remove-question" title="Remove Question">×</button>
                </div>
            </div>
        `;
        return questionItem;
    }

    container.addEventListener('click', function(e) {
        if (e.target.classList.contains('move-up')) {
            const item = e.target.closest('.question-item');
            const prevItem = item.previousElementSibling;
            if (prevItem) {
                container.insertBefore(item, prevItem);
                updateQuestionNumbers();
            }
        } else if (e.target.classList.contains('move-down')) {
            const item = e.target.closest('.question-item');
            const nextItem = item.nextElementSibling;
            if (nextItem) {
                container.insertBefore(nextItem, item);
                updateQuestionNumbers();
            }
        } else if (e.target.classList.contains('remove-question')) {
            const item = e.target.closest('.question-item');
            item.remove();
            updateQuestionNumbers();
        }
    });

    document.getElementById('add-question').addEventListener('click', function() {
        const newQuestionItem = createQuestionItem();
        container.appendChild(newQuestionItem);
        updateQuestionNumbers();
    });

    document.getElementById('regenerate-questions').addEventListener('click', function(e) {
        e.preventDefault();
        if (confirm('Are you sure you want to regenerate the questions? This will replace all current questions.')) {
            fetch('{{ url_for("regenerate_questions") }}', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        container.innerHTML = '';
                        data.questions.forEach(question => {
                            const newQuestionItem = createQuestionItem(question);
                            container.appendChild(newQuestionItem);
                        });
                        updateQuestionNumbers();
                    } else {
                        alert('Failed to regenerate questions. Please try again.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while regenerating questions.');
                });
        }
    });
});
</script>
{% endblock %}